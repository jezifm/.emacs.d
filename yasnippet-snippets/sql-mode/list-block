# -*- mode: snippet -*-
# name: list-block
# key: list-block
# --
with extracted as (
    select
        *
    from
        pg_stat_activity
),
temp_tables as (
    select
        pid,
        (regexp_matches(query, 'tmp_\w+'))[1] as temp_table
    from
        extracted
),
filtered as (
    select
        pid,
        usename,
        state,
        pg_blocking_pids(pid) as blocking_pid,
        round((EXTRACT(EPOCH FROM current_timestamp - query_start)/60)::numeric,1) as duration_min
        -- left(trim(query), 50) query
    from
        extracted
),
blocking_pids as (
    select
        pid,
        unnest(blocking_pid) as blocking_pid
    from
        filtered
),
final as (
    select
        f.*,
        tt.temp_table,
        bp.blocking_pid,
        bf.duration_min as blocking_min
    from
        filtered f
    left join
        temp_tables tt
    on
        f.pid = tt.pid
    left join
        blocking_pids bp
    on
        f.pid = bp.pid
    left join
        filtered bf
    on
        bp.blocking_pid = bf.pid
    order by
        duration_min desc nulls last
)
select
    *
from
    final
$0;
